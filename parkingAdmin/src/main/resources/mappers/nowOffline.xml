<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="nowOffline">
	<!-- 현장현황 -->
	<!-- 예약자리조회 -->
	<select id="selectBookingSpot" parameterType="com.parking.booking.vo.BookingVO"
		resultType="com.parking.booking.vo.BookingVO">
		select *
		from booking
		where bookingDate =
		#{selectDate} and
		bookingState between 0 and 1
	</select>

	<!-- 패널티(벌금)부여 -->
	<update id="updatePenalty" parameterType="com.parking.booking.vo.BookingVO">
		update payment
		set
		paymentPenalty = #{penalty}
		where
		paymentNum = #{paymentNum}
	</update>

	<!-- bookingParkingInsert:예약차량 입차확인 -->
	<update id="updateBooking" parameterType="com.parking.booking.vo.BookingVO">
		update booking
		set
		bookingState = 1
		where
		bookingNum = #{bookingNum}
	</update>

	<!-- 현장차량insert -->
	<insert id="insertOffline" parameterType="com.parking.nowoffline.vo.NowOfflineVO">
		insert into nowOffline
		(offlineNum,offlineSpot,offlineName,offlinePhone,offlineCarNum,offlineDiscount,offlineIntime)
		values(#{offlineNum},#{offlineSpot},#{offlineName},#{offlinePhone},#{offlineCarNum},#{offlineDiscount},sysdate)
	</insert>

	<!-- 현장자리조회 -->
	<select id="selectOfflineSpot" parameterType="com.parking.nowoffline.vo.NowOfflineVO"
		resultType="com.parking.nowoffline.vo.NowOfflineVO">
		select *
		from nowOffline
		where
		to_char(offlineIntime,'yy/mm/dd') = to_char(sysdate,'yy/mm/dd') and
		offlineState =1
	</select>

	<!-- offlineOut:현장차량 퇴차(update) -->
	<update id="updateOfflineOut" parameterType="com.parking.nowoffline.vo.NowOfflineVO">
		update nowOffline
		set
		paymentNum = #{paymentNum} , offlineOutTime = sysdate ,
		offlineTime
		= #{offlineTime} , offlineMoney = #{offlineMoney} ,
		offlineState = 0
		where
		offlineNum = #{offlineNum}
	</update>

	<!-- offlineOut:현장차량 퇴차(결제insert) -->
	<insert id="insertPaymentOut" parameterType="com.parking.nowoffline.vo.NowOfflineVO">
		insert into payment
		(paymentNum,cardCompany,cardNum,cardValid,cardCVC,paymentMoney,paymentPolicy,paymentDate,paymentType,paymentState,offlineNum)
		values(#{paymentNum},'auto','auto','auto','auto',#{offlineMoney},1,sysdate,2,1,#{offlineNum})
	</insert>

	<delete id="deleteOffline" parameterType="com.parking.nowoffline.vo.NowOfflineVO">
		delete from nowOffline
		where offlineNum = #{offlineNum}
	</delete>

	<select id="selectBookingSpotCount" parameterType="com.parking.nowoffline.vo.NowOfflineVO"
		resultType="int">
		select count(1) from booking where
		to_char(bookingDate,'yy/mm/dd') =
		to_char(sysdate,'yy/mm/dd') and
		bookingState between 0 and 1
	</select>

	<select id="selectOfflineSpotCount" parameterType="com.parking.nowoffline.vo.NowOfflineVO"
		resultType="int">
		select count(1) from nowoffline
		where
		to_char(offlineIntime,'yy/mm/dd') = to_char(sysdate,'yy/mm/dd')
		and
		offlineState = 1
	</select>

	<!-- 마감처리(모두사용으로변경) -->
	<update id="updateOfflineEnd" parameterType="com.parking.nowoffline.vo.NowOfflineVO">
		update booking
		set
		bookingState = 1
		where to_char(bookingDate,'yy/mm/dd') =
		to_char(sysdate,'yy/mm/dd') and
		bookingState = 0
	</update>
</mapper>
